async function fetchDecryptedData() {
    try {
        console.log("تحميل المفتاح...");
        const keyResponse = await fetch('key.key');
        if (!keyResponse.ok) throw new Error("تعذر تحميل ملف المفتاح.");
        const key = await keyResponse.text().trim();
        console.log("تم تحميل المفتاح:", key);

        console.log("تحميل البيانات المشفرة...");
        const encryptedResponse = await fetch('students_encrypted.json');
        if (!encryptedResponse.ok) throw new Error("تعذر تحميل ملف البيانات المشفرة.");
        const encryptedData = await encryptedResponse.text();
        console.log("تم تحميل البيانات المشفرة:", encryptedData);

        // فك التشفير
        console.log("فك التشفير...");
        const bytes = CryptoJS.AES.decrypt(encryptedData, key);
        const decryptedData = bytes.toString(CryptoJS.enc.Utf8);

        if (!decryptedData) throw new Error("فك التشفير فشل، البيانات فارغة");

        console.log("البيانات المفككة:", decryptedData);
        return JSON.parse(decryptedData);
    } catch (error) {
        console.error("خطأ أثناء فك التشفير:", error.message);
        return null;
    }
}

async function getStudentEmails() {
    let phone = document.getElementById('phone').value;
    phone = convertToArabicNumbers(phone);
    
    const resultElement = document.getElementById('result');
    const tableContainer = document.getElementById('students-table');
    resultElement.textContent = "جارٍ الاستعلام...";
    tableContainer.innerHTML = ""; 

    if (!phone.trim()) {
        resultElement.textContent = "يرجى إدخال رقم هاتف صحيح.";
        return;
    }

    try {
        const data = await fetchDecryptedData();  // استدعاء وظيفة فك التشفير
        if (!data) {
            resultElement.textContent = "حدث خطأ أثناء تحميل البيانات.";
            return;
        }

        console.log("البيانات:", data);
        const students = data.filter(student => student.phone === parseInt(phone));
        if (students.length > 0) {
            resultElement.textContent = `تم العثور على ${students.length} طالب:`;

            const table = document.createElement('table');
            const headerRow = `
                <tr>
                    <th>اسم الطالب</th>
                    <th>البريد الإلكتروني</th>
                </tr>`;
            table.innerHTML = headerRow;

            students.forEach(student => {
                const email = student.email ? student.email : "البريد الإلكتروني غير موجود";
                const row = `
                    <tr>
                        <td>${student.name}</td>
                        <td>${email}</td>
                    </tr>`;
                table.innerHTML += row;
            });

            tableContainer.appendChild(table);
        } else {
            resultElement.textContent = "لم يتم العثور على طلاب بهذا الرقم المسجل.";
        }
    } catch (error) {
        resultElement.textContent = "حدث خطأ أثناء الاستعلام. تحقق من اتصال الإنترنت.";
        console.error(error);
    }
}
